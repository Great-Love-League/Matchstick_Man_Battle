<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>My Game</title>
    
    <!-- æœ¬åœ° jQuery æˆ–ä½¿ç”¨ HTTPS CDN -->
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript">
    // ç¡®ä¿ jQuery åŠ è½½æˆåŠŸåæ‰è®¾ç½® Object.extend
    if (typeof jQuery !== 'undefined') {
        jQuery.noConflict();
        Object.extend = jQuery.extend;
    } else {
        // é™çº§æ–¹æ¡ˆï¼šç®€å•çš„ extend å®ç°
        Object.extend = function(target, source) {
            for (var key in source) {
                if (source.hasOwnProperty(key)) {
                    target[key] = source[key];
                }
            }
            return target;
        };
    }
    </script>
    
    <style type="text/css">
        @font-face {
            font-family: "ThaleahFat";
            src: url("./ThaleahFat.ttf") format("truetype");
            font-weight: normal;
            font-style: normal;
        }
    </style>
    
    <script src="./box2d.js"></script>
    <script src="./.mooncakes/Demonmasterlqx/MoonP5/p5.js"></script>
    
    <script>
    // ä¸´æ—¶é˜²æŠ¤ï¼šç¡®ä¿å¸¸ç”¨ç»˜å›¾å˜é‡/å‡½æ•°åœ¨å…¨å±€å­˜åœ¨ï¼Œé¿å… p5 çš„ scope å¼•å‘ç©ºå€¼è­¦å‘Š
    // ç”Ÿæˆçš„ server.js ç›´æ¥å¼•ç”¨ bare identifier `min`/`max`ï¼Œéœ€è¦çœŸæ­£çš„å…¨å±€ç»‘å®šï¼ˆvar æˆ–é¡¶å±‚èµ‹å€¼ï¼‰
    if (typeof min === 'undefined') { var min = Math.min; window.min = min; }
    if (typeof max === 'undefined') { var max = Math.max; window.max = max; }
        // å½“ color() æˆ– beginShape å‚æ•°æœªå®šä¹‰æ—¶ï¼Œç»™å‡ºå®‰å…¨é»˜è®¤å€¼
        (function(){
            const _origColor = window.color;
            if (typeof _origColor === 'function') {
                window.color = function(r,g,b,a){
                    if (r === undefined) r = 0;
                    if (g === undefined) g = r;
                    if (b === undefined) b = r;
                    if (a === undefined) a = 255;
                    return _origColor.call(this, r,g,b,a);
                };
            }
            const _origBeginShape = window.beginShape;
            if (typeof _origBeginShape === 'function') {
                window.beginShape = function(mode){
                    if (mode === undefined) mode = POINTS;
                    return _origBeginShape.call(this, mode);
                };
            }
            const _origEndShape = window.endShape;
            if (typeof _origEndShape === 'function') {
                window.endShape = function(mode, closeMode){
                    if (mode === undefined) mode = 0;
                    if (closeMode === undefined) closeMode = false;
                    return _origEndShape.call(this, mode, closeMode);
                };
            }
        })();
            // Patch p5 instance methods to default missing alpha to 255 to silence warnings
            (function(){
                try {
                    if (typeof p5 !== 'undefined' && p5 && p5.prototype) {
                        const proto = p5.prototype;
                        if (typeof proto.color === 'function') {
                            const _origColor = proto.color;
                            proto.color = function(r,g,b,a){
                                if (arguments.length === 3) a = 255;
                                if (a === undefined) a = 255;
                                return _origColor.call(this, r, g === undefined ? r : g, b === undefined ? r : b, a);
                            };
                        }
                        if (typeof proto.fill === 'function') {
                            const _origFill = proto.fill;
                            proto.fill = function(r,g,b,a){
                                if (arguments.length === 1 && typeof r === 'object') return _origFill.call(this, r);
                                if (arguments.length === 3) a = 255;
                                if (a === undefined) a = 255;
                                return _origFill.call(this, r, g, b, a);
                            };
                        }
                    }
                } catch(e){ console.warn('p5 patch failed', e); }
            })();
        </script>
            <div id="debug-bar" style="position:fixed;right:8px;bottom:8px;padding:6px 10px;background:rgba(0,0,0,0.6);color:white;border-radius:6px;font-size:12px;z-index:9999">app children: <span id="debug-count">0</span></div>
            <script>
            // Simple debug UI to show whether #app is populated
            (function(){
                const countEl = document.getElementById('debug-count');
                const appEl = document.getElementById('app');
                const update = () => {
                    const n = appEl ? appEl.childElementCount : 0;
                    countEl.textContent = String(n);
                    if (appEl) {
                        if (n > 0) appEl.classList.add('demo-debug-outline');
                        else appEl.classList.remove('demo-debug-outline');
                    }
                };
                setInterval(update, 300);
                window.addEventListener('load', update);
            })();
            </script>
    <script src="./target/js/release/build/server/server.js"></script>
    <!-- Integrate moonbitgame-example frontend -->
</head>

<body>
    <!-- Example frontend mount point -->
    <div id="app"></div>
    <canvas id="canvas" style="display: block; margin: 0 auto;" height="32" width="32"></canvas>
        <div id="page-log" style="position:fixed;left:8px;bottom:8px;max-width:40%;max-height:40%;overflow:auto;background:rgba(255,255,255,0.9);color:#111;padding:8px;border-radius:6px;font-size:12px;z-index:9998">logs:<div id="page-log-inside"></div></div>
        <script>
            // Inline execution smoke-test
            try {
                const inside = document.getElementById('page-log-inside');
                if (inside) {
                    const el = document.createElement('div');
                    el.textContent = 'inline-script: ' + new Date().toISOString();
                    inside.appendChild(el);
                }
                console.log('inline-script ran');
            } catch(e) { console.error('inline-script error', e); }
        </script>
        <script>
        // åœ¨ Rabbit-TEA æ¸²æŸ“å®Œæˆåï¼Œå°†åŸæœ‰ canvas ç§»å…¥ç¤ºä¾‹çš„ Game Area
        window.addEventListener('load', () => {
            const tryMove = () => {
                function findGameArea() {
                    // Try several strategies in order of reliability.
                    // 1) Prefer full playfield container (820x560) if present
                    const fullByClass = document.querySelector('.w-\\[820px\\].h-\\[560px\\]');
                    if (fullByClass) return fullByClass;

                    const fullByInline = Array.from(document.querySelectorAll('div[style]')).find(d => {
                        const s = (d.getAttribute('style') || '').replace(/\s+/g, '');
                        return s.includes('width:820px') && s.includes('height:560px');
                    });
                    if (fullByInline) return fullByInline;

                    // 2) Fallback to inner demo playfield (680x360) used by Rabbit-TEA example
                    const byClass = document.querySelector('.w-\\[680px\\].h-\\[360px\\]') || document.querySelector('.w-\\[680px\\]');
                    if (byClass) return byClass;

                    const byInline = Array.from(document.querySelectorAll('div[style]')).find(d => {
                        const s = (d.getAttribute('style') || '').replace(/\s+/g, '');
                        return s.includes('width:680px') || s.includes('height:360px');
                    });
                    if (byInline) return byInline;

                    // 3) find a div containing the text "Game Area" and then prefer a descendant that looks like the playfield
                    const textNodes = Array.from(document.querySelectorAll('div'));
                    for (const n of textNodes) {
                        try {
                            if (n.textContent && n.textContent.includes('Game Area')) {
                                // Prefer a nearby child that has expected size classes or inline size
                                const found = n.querySelector('.w-\\[680px\\].h-\\[360px\\]') || n.querySelector('.w-\\[680px\\]') || Array.from(n.querySelectorAll('div[style]')).find(d => {
                                    const s = (d.getAttribute('style') || '').replace(/\s+/g, '');
                                    return s.includes('width:680px') || s.includes('height:360px');
                                });
                                if (found) return found;
                                // As a last resort, return the closest div that contains the text
                                return n.closest('div');
                            }
                        } catch (e) { /* ignore */ }
                    }

                    return null;
                }
                let target = findGameArea() || document.querySelector('.w-\\[680px\\]') || document.querySelector('[class*="Game Area"]') || document.getElementById('app');
                // If we ended up with the root #app, prefer an inner playfield if present
                try {
                    if (target && target.id === 'app') {
                        const inner = target.querySelector('.w-\\[680px\\].h-\\[360px\\]') || target.querySelector('.w-\\[680px\\]') || Array.from(target.querySelectorAll('div')).find(n => n.textContent && n.textContent.includes('Game Area'));
                        if (inner) {
                            console.log('tryMove: found inner playfield inside #app, using that instead', inner);
                            target = inner;
                        } else {
                            // No inner playfield present yet â€” do NOT mutate #app, keep it empty so Rabbit-TEA can mount.
                            // Instead, create a temporary overlay host on <body> and wait for Rabbit-TEA to render, then relocate.
                            console.log('tryMove: waiting for Rabbit-TEA mount; using temporary overlay host');
                            let overlay = document.getElementById('__wait_rabbitea_overlay');
                            if (!overlay) {
                                overlay = document.createElement('div');
                                overlay.id = '__wait_rabbitea_overlay';
                                overlay.style.position = 'fixed';
                                overlay.style.left = '50%';
                                overlay.style.top = '50%';
                                overlay.style.transform = 'translate(-50%, -50%)';
                                overlay.style.width = '820px';
                                overlay.style.height = '560px';
                                overlay.style.zIndex = 9997;
                                overlay.style.background = 'transparent';
                                overlay.style.pointerEvents = 'none';
                                document.body.appendChild(overlay);
                            }
                            target = overlay;
                        }
                    }
                } catch(e) { console.warn('tryMove: inner-target check failed', e); }
                // Prefer a canvas already inside the target (if present), otherwise fall back to global canvas ids
                let canvas = null;
                if (target) canvas = target.querySelector('canvas');
                if (!canvas) canvas = document.getElementById('defaultCanvas0') || document.querySelector('canvas') || document.getElementById('canvas');
                if (target && canvas) {
                    try {
                        // decorate for debug visibility
                        try {
                            const prev = document.getElementById('__game_target_debug');
                            if (prev && prev.parentElement) prev.parentElement.removeChild(prev);
                        } catch(e){}
                        try {
                            const info = document.createElement('div');
                            info.id = '__game_target_debug';
                            info.style.position = 'fixed';
                            info.style.right = '8px';
                            info.style.top = '8px';
                            info.style.background = 'rgba(0,0,0,0.7)';
                            info.style.color = 'white';
                            info.style.zIndex = 10000;
                            info.style.padding = '6px 8px';
                            info.style.fontSize = '12px';
                            info.style.borderRadius = '6px';
                            info.textContent = 'game debug: locating target...';
                            document.body.appendChild(info);
                        } catch(e){ console.warn('debug info attach failed', e); }

                        // ensure the container can position absolute children
                        const prevPos = window.getComputedStyle(target).position;
                        if (prevPos === 'static' || !prevPos) target.style.position = 'relative';
                        // ensure the container has a sensible minimum size for the game area
                        if (!target.style.minWidth) target.style.minWidth = '680px';
                        if (!target.style.minHeight) target.style.minHeight = '360px';
                        // compute available pixel area
                        let cw = Math.max(1, target.clientWidth || 680);
                        let ch = Math.max(1, target.clientHeight || 360);

                        // If the target is suspiciously small, create a safe overlay host so the game is visible
                        if (cw < 200 || ch < 200) {
                            console.warn('found small target, creating fallback host', cw, ch, target);
                            let fallback = document.getElementById('__injected_game_host');
                            if (!fallback) {
                                fallback = document.createElement('div');
                                fallback.id = '__injected_game_host';
                                fallback.style.position = 'fixed';
                                fallback.style.left = '50%';
                                fallback.style.top = '50%';
                                fallback.style.transform = 'translate(-50%, -50%)';
                                fallback.style.width = '680px';
                                fallback.style.height = '360px';
                                fallback.style.zIndex = 9997;
                                fallback.style.background = 'rgba(0,0,0,0.03)';
                                fallback.style.border = '2px dashed rgba(0,0,0,0.06)';
                                fallback.style.borderRadius = '8px';
                                document.body.appendChild(fallback);
                            }
                            // switch the target to the fallback host
                            target = fallback;
                            cw = 680; ch = 360;
                        }

                        // move canvas into target if not already â€” insert as first child so UI elements render above it
                        if (!target.contains(canvas)) {
                            try {
                                target.insertBefore(canvas, target.firstChild);
                            } catch(e) {
                                target.appendChild(canvas);
                            }
                        }

                        // Set canvas pixel size to the game's logical resolution (820x560) and scale to fit target without cropping
                        try {
                            const desiredW = 820;
                            const desiredH = 560;
                            const dpr = window.devicePixelRatio || 1;
                            // Always keep the backing store at logical size for crisp rendering
                            canvas.width = Math.max(1, Math.floor(desiredW * dpr));
                            canvas.height = Math.max(1, Math.floor(desiredH * dpr));

                            // Compute scale to fit inside cw x ch while preserving aspect ratio
                            const scale = Math.max(0.01, Math.min(cw / desiredW, ch / desiredH));
                            const cssW = Math.floor(desiredW * scale);
                            const cssH = Math.floor(desiredH * scale);
                            canvas.style.width = cssW + 'px';
                            canvas.style.height = cssH + 'px';
                        } catch(e) { console.warn('set canvas pixel size failed', e); }

                        // Center the canvas in target (letterbox), avoid cropping
                        canvas.style.position = 'absolute';
                        canvas.style.left = '50%';
                        canvas.style.top = '50%';
                        canvas.style.transform = 'translate(-50%, -50%)';
                        // ensure canvas sits behind UI elements and does not block pointer events
                        canvas.style.zIndex = '0';
                        canvas.style.pointerEvents = 'none';
                        canvas.style.display = 'block';

                        try { const dbg = document.getElementById('__game_target_debug'); if (dbg) dbg.textContent = `game debug: target=${target.tagName} id=${target.id||''} class=${(target.className||'').toString().slice(0,80)} size=${cw}x${ch}`; } catch(e){}
                        console.log('tryMove: canvas resized to', cw, ch, 'and moved into target', target, 'canvas attrs', canvas.width, canvas.height);
                        // Notify libraries that size changed
                        try { window.dispatchEvent(new Event('resize')); } catch(e) { console.warn('dispatch resize failed', e); }
                    } catch(e){ console.warn('tryMove failed', e); }
                } else {
                    setTimeout(tryMove, 200);
                }
            };
            tryMove();

            // Observe #app for dynamic mounts (move injected playfield into real demo card when it appears)
            (function(){
                try {
                    const appEl = document.getElementById('app');
                    if (!appEl) return;
                    let observed = false;
                    const mo = new MutationObserver((mutations)=>{
                        try {
                            // prefer the real playfield if it appears
                            const realPlay = document.querySelector('.w-\\[820px\\].h-\\[560px\\]') || document.querySelector('.w-\\[680px\\].h-\\[360px\\]') || document.querySelector('.w-\\[680px\\]');
                            const injected = document.getElementById('__auto_playfield');
                            const demoCard = document.querySelector('div[style*="width:820px"][style*="height:560px"]') || document.querySelector('.min-h-screen');
                            if (realPlay) {
                                // move canvas into the real playfield
                                const canvas = document.querySelector('canvas');
                                if (canvas && realPlay && canvas.parentElement !== realPlay) {
                                    try { realPlay.insertBefore(canvas, realPlay.firstChild); } catch(e){ realPlay.appendChild(canvas); }
                                    console.log('observer: moved canvas into realPlay', realPlay);
                                    // remove temporary overlay if exists
                                    try { const ov = document.getElementById('__wait_rabbitea_overlay'); if (ov && ov.parentElement) ov.parentElement.removeChild(ov); } catch(e){}
                                    // ensure Rabbit-TEA HUD overlay is present
                                    try { if (window.__ensureRabbitHUD) window.__ensureRabbitHUD(); } catch(e) { console.warn('ensureRabbitHUD failed', e); }
                                    tryMove();
                                    mo.disconnect();
                                    observed = true;
                                    return;
                                }
                            }
                            if (injected && demoCard && injected.parentElement !== demoCard) {
                                demoCard.appendChild(injected);
                                console.log('observer: moved __auto_playfield into demoCard', demoCard);
                                tryMove();
                                mo.disconnect();
                                observed = true;
                                return;
                            }
                        } catch(e) { console.warn('observer loop error', e); }
                    });
                    mo.observe(appEl, { childList:true, subtree:true });
                    // Safety: disconnect after 10s if not resolved
                    setTimeout(()=>{ try { mo.disconnect(); } catch(e){} }, 10000);
                } catch(e){ console.warn('observer setup failed', e); }
            })();
        });
        </script>
        <script>
        // Provide a unified game UI API and inject a HUD overlay into the Rabbit-TEA card when available
        (function(){
                function ensureGameUI(){
                        if (!window.gameUI) {
                                window.gameUI = {
                                        updateHP: function(player, current, max){
                                                const bar = document.getElementById('hp-bar-p' + player);
                                                const text = document.getElementById('hp-text-p' + player);
                                                if (bar && text) {
                                                        const percent = Math.max(0, Math.min(100, (current / max) * 100));
                                                        bar.style.width = percent + '%';
                                                        text.textContent = Math.round(current) + '/' + Math.round(max);
                                                }
                                        },
                                        updateWins: function(player, wins){
                                                const el = document.getElementById('wins-p' + player);
                                                if (el) el.textContent = wins;
                                        },
                                        setStatus: function(text){
                                                const el = document.getElementById('game-status');
                                                if (el) el.textContent = text;
                                        },
                                        onStartGame: null
                                };
                        }
                }

                function findRabbitCard(){
                        let card = document.querySelector('.w-\\[820px\\].h-\\[560px\\]');
                        if (card) return card;
                        card = Array.from(document.querySelectorAll('div[style]')).find(d => {
                                const s = (d.getAttribute('style')||'').replace(/\s+/g,'');
                                return s.includes('width:820px') && s.includes('height:560px');
                        });
                        if (card) return card;
                        // fallback: use the parent of the 680x360 playfield
                        const play = document.querySelector('.w-\\[680px\\].h-\\[360px\\]') || document.querySelector('.w-\\[680px\\]');
                        return play ? play.closest('div') : null;
                }

                function ensureRabbitHUD(){
                    // If Rabbit-TEA already rendered its own start button, just wire it and skip overlay injection
                    const teaBtn = document.getElementById('rt-start-btn');
                    if (teaBtn) {
                        ensureGameUI();
                        if (!teaBtn.__wired) {
                            teaBtn.addEventListener('click', function(){
                                if (window.gameUI && window.gameUI.onStartGame) window.gameUI.onStartGame();
                                if (window.gameUI) window.gameUI.setStatus('æ¸¸æˆè¿›è¡Œä¸­...');
                                try { teaBtn.textContent = 'é‡æ–°å¼€å§‹'; } catch(e){}
                            });
                            teaBtn.__wired = true;
                        }
                        return true;
                    }

                    const card = findRabbitCard();
                        if (!card) return false;
                    // If card exists but TEA didn't render a button, create a minimal button within the card
                    let teaBtn2 = document.getElementById('rt-start-btn');
                    if (!teaBtn2) {
                        teaBtn2 = document.createElement('button');
                        teaBtn2.id = 'rt-start-btn';
                        teaBtn2.textContent = 'å¼€å§‹æ¸¸æˆ';
                        teaBtn2.style.position = 'absolute';
                        teaBtn2.style.left = '50%';
                        teaBtn2.style.top = '10px';
                        teaBtn2.style.transform = 'translateX(-50%)';
                        teaBtn2.style.padding = '8px 16px';
                        teaBtn2.style.fontSize = '13px';
                        teaBtn2.style.fontWeight = '600';
                        teaBtn2.style.color = '#fff';
                        teaBtn2.style.background = 'linear-gradient(135deg,#3b82f6,#2563eb)';
                        teaBtn2.style.border = 'none';
                        teaBtn2.style.borderRadius = '8px';
                        teaBtn2.style.cursor = 'pointer';
                        teaBtn2.style.boxShadow = '0 4px 10px rgba(37,99,235,0.25)';
                        teaBtn2.style.zIndex = '6';
                        card.appendChild(teaBtn2);
                        // wire it
                        ensureGameUI();
                        teaBtn2.addEventListener('click', function(){
                            if (window.gameUI && window.gameUI.onStartGame) window.gameUI.onStartGame();
                            if (window.gameUI) window.gameUI.setStatus('æ¸¸æˆè¿›è¡Œä¸­...');
                            try { teaBtn2.textContent = 'é‡æ–°å¼€å§‹'; } catch(e){}
                        });
                        teaBtn2.__wired = true;
                    }
                        const prevPos = window.getComputedStyle(card).position;
                        if (prevPos === 'static' || !prevPos) card.style.position = 'relative';
                        let hud = document.getElementById('ui-overlay');
                        if (!hud) {
                                hud = document.createElement('div');
                                hud.id = 'ui-overlay';
                                hud.style.position = 'absolute';
                                hud.style.left = '0';
                                hud.style.top = '0';
                                hud.style.right = '0';
                                hud.style.bottom = '0';
                                hud.style.pointerEvents = 'none';
                                hud.style.zIndex = 5; // above canvas (zIndex 0) and below any dialogs
                                                hud.innerHTML = `
                <div style="position:absolute;top:8px;left:8px;right:8px;display:flex;justify-content:space-between;gap:12px;align-items:center;">
                    <div style="flex:1;max-width:46%;background:rgba(241,245,249,0.9);padding:8px 10px;border-radius:10px;backdrop-filter:blur(4px);box-shadow:0 2px 8px rgba(0,0,0,0.08);pointer-events:none;">
        <div style="font-size:12px;color:#334155;margin-bottom:6px;">ç©å®¶ 1</div>
        <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:12px;color:#64748b;">HP</span>
            <div style="flex:1;height:14px;background:#e2e8f0;border-radius:8px;overflow:hidden;position:relative;">
                <div id="hp-bar-p1" style="height:100%;background:linear-gradient(90deg,#ef4444,#dc2626);width:100%;transition:width 0.2s;"></div>
            </div>
            <span id="hp-text-p1" style="font-size:12px;font-weight:600;color:#1e293b;min-width:48px;text-align:right;">100/100</span>
            <span style="font-size:12px;color:#64748b;margin-left:6px;">Win:<span id="wins-p1" style="font-weight:700;color:#059669;margin-left:4px;">0</span></span>
        </div>
    </div>
    <div style="flex:1;max-width:46%;background:rgba(241,245,249,0.9);padding:8px 10px;border-radius:10px;backdrop-filter:blur(4px);box-shadow:0 2px 8px rgba(0,0,0,0.08);pointer-events:none;">
        <div style="font-size:12px;color:#334155;margin-bottom:6px;text-align:right;">ç©å®¶ 2</div>
        <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:12px;color:#64748b;">HP</span>
            <div style="flex:1;height:14px;background:#e2e8f0;border-radius:8px;overflow:hidden;position:relative;">
                <div id="hp-bar-p2" style="height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:100%;transition:width 0.2s;"></div>
            </div>
            <span id="hp-text-p2" style="font-size:12px;font-weight:600;color:#1e293b;min-width:48px;text-align:left;">100/100</span>
            <span style="font-size:12px;color:#64748b;margin-left:6px;">Win:<span id="wins-p2" style="font-weight:700;color:#059669;margin-left:4px;">0</span></span>
        </div>
    </div>
</div>
<div style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,0.6);color:white;font-size:12px;padding:6px 10px;border-radius:8px;backdrop-filter:blur(2px);pointer-events:none;" id="game-status">å‡†å¤‡å°±ç»ª</div>`;
                                card.appendChild(hud);
                                                // No button here; the start button comes from Rabbit-TEA (id=rt-start-btn)
                        }
                        ensureGameUI();
                        return true;
                }

                // Expose for other scripts (observer) to call when mount is detected
                window.__ensureRabbitHUD = ensureRabbitHUD;
                ensureGameUI();

                // Try to mount HUD soon after load in case Rabbit-TEA is already rendered
                let tries = 0;
                const intId = setInterval(()=>{
                        if (ensureRabbitHUD()) { clearInterval(intId); return; }
                        if (++tries > 60) clearInterval(intId);
                }, 150);
        })();
        </script>
    <link rel="stylesheet" href="./moonbitgame-example/styles.css">
    <script>
    // Proxy console to write into page-log as well
    (function(){
        const out = document.getElementById('page-log-inside');
        if (!out) return;
        const wrap = (kind) => (...args) => {
            try { const el = document.createElement('div'); el.textContent = kind + ': ' + args.map(a=>{ try { return typeof a === 'string'?a:JSON.stringify(a);} catch(e){ return String(a);} }).join(' '); out.appendChild(el); out.scrollTop = out.scrollHeight; } catch(e){}
            return original[kind].apply(console, args);
        };
        const original = { log: console.log, warn: console.warn, error: console.error };
        console.log = wrap('log'); console.warn = wrap('warn'); console.error = wrap('error');
    })();
    window.addEventListener('error', (e) => {
        console.error('global error captured', e.error || e.message, e);
    });
    window.addEventListener('unhandledrejection', (ev) => {
        console.error('unhandledrejection', ev.reason);
    });
    console.log('bootloader: loading example bundle via script tag');
    </script>
    <!-- Load example module directly (IIFE will execute and mount UI) -->
    <!-- Note: This may conflict with server.js due to duplicate global declarations -->
    <script>
    // Detect if example module will fail to load (e.g., duplicate $PanicError class)
    // If so, immediately inject fallback UI so the game can be displayed
    (function(){
        let loadFailed = false;
        const errHandler = (e) => {
            if (e && e.message && e.message.includes('$PanicError')) {
                loadFailed = true;
                console.warn('bootloader: example module load conflict detected (duplicate $PanicError), injecting fallback UI immediately');
                // Inject fallback UI right away
                try {
                    const app = document.getElementById('app');
                    if (app && app.childElementCount === 0) {
                        const fallback = `
<div class="min-h-screen flex items-center justify-center" style="font-family:system-ui;padding:16px;background:linear-gradient(180deg,#bfdbfe,#c7d2fe,#ddd6fe)">
    <div style="width:900px;background:rgba(255,255,255,0.95);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.15);display:flex;flex-direction:column;overflow:visible;padding:20px;">
        <!-- æ ‡é¢˜åŒº -->
        <div style="text-align:center;margin-bottom:20px;">
            <h1 style="font-size:32px;font-weight:700;color:#1e293b;margin:0 0 8px 0;">ç«æŸ´äººå¤§ä¹±æ–—</h1>
            <p style="font-size:14px;color:#64748b;margin:0;">Matchstick Man Battle</p>
        </div>
        
        <!-- æ¸¸æˆçŠ¶æ€å’Œæ§åˆ¶åŒº -->
        <div style="display:flex;gap:20px;margin-bottom:20px;align-items:center;justify-content:space-between;padding:16px;background:linear-gradient(135deg,#f1f5f9,#e2e8f0);border-radius:12px;">
            <div style="flex:1;">
                <div style="font-size:16px;font-weight:600;color:#334155;margin-bottom:8px;">ç©å®¶ 1</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:14px;color:#64748b;">HP:</span>
                    <div style="flex:1;height:20px;background:#cbd5e1;border-radius:10px;overflow:hidden;position:relative;">
                        <div id="hp-bar-p1" style="height:100%;background:linear-gradient(90deg,#ef4444,#dc2626);width:100%;transition:width 0.3s;"></div>
                    </div>
                    <span id="hp-text-p1" style="font-size:14px;font-weight:600;color:#1e293b;min-width:60px;">100/100</span>
                </div>
                <div style="margin-top:8px;font-size:14px;color:#64748b;">èƒœåˆ©: <span id="wins-p1" style="font-weight:600;color:#059669;">0</span></div>
            </div>
            
            <div style="text-align:center;">
                <button id="start-game-btn" style="padding:12px 32px;font-size:16px;font-weight:600;color:white;background:linear-gradient(135deg,#3b82f6,#2563eb);border:none;border-radius:8px;cursor:pointer;box-shadow:0 4px 12px rgba(59,130,246,0.3);transition:all 0.2s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(59,130,246,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.3)'">å¼€å§‹æ¸¸æˆ</button>
                <div id="game-status" style="margin-top:12px;font-size:14px;font-weight:500;color:#64748b;">ç­‰å¾…å¼€å§‹...</div>
            </div>
            
            <div style="flex:1;text-align:right;">
                <div style="font-size:16px;font-weight:600;color:#334155;margin-bottom:8px;">ç©å®¶ 2</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span id="hp-text-p2" style="font-size:14px;font-weight:600;color:#1e293b;min-width:60px;">100/100</span>
                    <div style="flex:1;height:20px;background:#cbd5e1;border-radius:10px;overflow:hidden;position:relative;">
                        <div id="hp-bar-p2" style="height:100%;background:linear-gradient(90deg,#3b82f6,#2563eb);width:100%;transition:width 0.3s;"></div>
                    </div>
                    <span style="font-size:14px;color:#64748b;">HP:</span>
                </div>
                <div style="margin-top:8px;font-size:14px;color:#64748b;">èƒœåˆ©: <span id="wins-p2" style="font-weight:600;color:#059669;">0</span></div>
            </div>
        </div>
        
        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div style="display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(180deg,#f8fafc,#f1f5f9);border-radius:12px;position:relative;">
            <div id="game-area-fallback" style="width:820px;height:560px;position:relative;border:3px solid #cbd5e1;border-radius:8px;background:#ffffff;overflow:visible;padding:0;margin:0;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
            </div>
        </div>
        
        <!-- æ“ä½œè¯´æ˜ -->
        <div style="margin-top:20px;padding:16px;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:12px;border-left:4px solid #f59e0b;">
            <div style="font-size:14px;font-weight:600;color:#92400e;margin-bottom:8px;">ğŸ¯ æ“ä½œè¯´æ˜</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px;color:#78350f;">
                <div><strong>ç©å®¶1:</strong> WASDç§»åŠ¨ + Fæ”»å‡» + Gç‰¹æ®ŠæŠ€èƒ½</div>
                <div><strong>ç©å®¶2:</strong> æ–¹å‘é”®ç§»åŠ¨ + Læ”»å‡» + Kç‰¹æ®ŠæŠ€èƒ½</div>
            </div>
        </div>
    </div>
</div>`;
                        app.innerHTML = fallback;
                        console.log('bootloader: injected fallback UI due to load conflict');
                        
                        // è®¾ç½®æ¸¸æˆ API
                        window.gameUI = {
                            updateHP: function(player, current, max) {
                                const bar = document.getElementById('hp-bar-p' + player);
                                const text = document.getElementById('hp-text-p' + player);
                                if (bar && text) {
                                    const percent = Math.max(0, Math.min(100, (current / max) * 100));
                                    bar.style.width = percent + '%';
                                    text.textContent = Math.round(current) + '/' + Math.round(max);
                                }
                            },
                            updateWins: function(player, wins) {
                                const el = document.getElementById('wins-p' + player);
                                if (el) el.textContent = wins;
                            },
                            setStatus: function(text) {
                                const el = document.getElementById('game-status');
                                if (el) el.textContent = text;
                            },
                            onStartGame: null
                        };
                        
                        // å¼€å§‹æ¸¸æˆæŒ‰é’®äº‹ä»¶
                        const startBtn = document.getElementById('start-game-btn');
                        if (startBtn) {
                            startBtn.addEventListener('click', function() {
                                console.log('Start game button clicked');
                                if (window.gameUI.onStartGame) {
                                    window.gameUI.onStartGame();
                                }
                                window.gameUI.setStatus('æ¸¸æˆè¿›è¡Œä¸­...');
                                startBtn.textContent = 'é‡æ–°å¼€å§‹';
                            });
                        }
                        
                        console.log('bootloader: gameUI API initialized');
                        
                        // Retry moving canvas into the fallback game area
                        setTimeout(() => {
                            const gameArea = document.getElementById('game-area-fallback');
                            const canvas = document.querySelector('canvas');
                            const demoCard = gameArea ? gameArea.closest('div[style*="width:820px"][style*="background"]') : null;
                            if (gameArea && canvas) {
                                const cw = canvas.width || 680;
                                const ch = canvas.height || 360;
                                // å¤´éƒ¨+åº•éƒ¨é«˜åº¦
                                const extra = 56 + 40;
                                if (demoCard) {
                                    demoCard.style.setProperty('height', (ch + extra) + 'px', 'important');
                                    demoCard.style.setProperty('width', cw + 'px', 'important');
                                    demoCard.style.setProperty('overflow', 'visible', 'important');
                                    demoCard.style.setProperty('border-radius', '0', 'important');
                                }
                                // ç§»åŠ¨ canvas
                                if (!gameArea.contains(canvas)) {
                                    try {
                                        gameArea.insertBefore(canvas, gameArea.firstChild);
                                    } catch(e){ gameArea.appendChild(canvas); }
                                }
                                canvas.style.position = 'absolute';
                                canvas.style.left = '0';
                                canvas.style.top = '0';
                                canvas.style.width = cw + 'px';
                                canvas.style.height = ch + 'px';
                                canvas.style.zIndex = '0';
                                canvas.style.pointerEvents = 'auto';
                                canvas.style.display = 'block';
                                canvas.style.margin = '0';
                                canvas.style.padding = '0';
                                canvas.width = cw;
                                canvas.height = ch;
                                console.log('bootloader: moved canvas into fallback game area, auto resized to', cw, ch);
                                window.dispatchEvent(new Event('resize'));
                                // å†æ¬¡å»¶è¿Ÿä¿®æ­£ demoCard æ ·å¼ï¼Œé˜²æ­¢è¢«è¦†ç›–
                                setTimeout(() => {
                                    if (demoCard) {
                                        demoCard.style.setProperty('height', (ch + extra) + 'px', 'important');
                                        demoCard.style.setProperty('width', cw + 'px', 'important');
                                        demoCard.style.setProperty('overflow', 'visible', 'important');
                                        demoCard.style.setProperty('border-radius', '0', 'important');
                                    }
                                }, 500);
                            }
                        }, 100);
                    }
                } catch(e){ console.error('fallback inject on conflict failed', e); }
            }
        };
        window.addEventListener('error', errHandler);
        setTimeout(() => { window.removeEventListener('error', errHandler); }, 1000);
    })();
    </script>
    <!-- Load Rabbit-TEA example as an ES module to isolate its scope and avoid global symbol conflicts -->
    <script type="module" src="./moonbitgame-example/main/main.js"></script>
    <script>
    (function(){
        console.log('bootloader: example module loaded (IIFE should have executed)');
        // Poll app child count for a short period so we can see late mounts
        let checks = 0;
        const intId = setInterval(()=>{
                const appEl = document.getElementById('app');
                const n = appEl ? appEl.childElementCount : 0;
                console.log('bootloader: poll', checks, 'app present?', !!appEl, 'children=', n);
                checks += 1;
                if (checks > 20) {
                        clearInterval(intId);
                        // If nothing mounted, inject a visible fallback UI so the demo is visible
                        try {
                                const app = document.getElementById('app');
                                if (app && app.childElementCount === 0) {
                                        const fallback = `
<div class="min-h-screen flex items-center justify-center" style="font-family:system-ui;padding:16px">
    <div style="width:820px;height:560px;background:rgba(255,255,255,0.9);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.12);display:flex;flex-direction:column;overflow:hidden">
        <div style="padding:16px;border-bottom:1px solid rgba(0,0,0,0.06);font-size:20px;font-weight:600">Rabbit-TEA: Demo Game</div>
        <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:24px">
            <div style="width:680px;height:360px;border:2px dashed #d1d5db;border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#f8fafc,#eef2ff)">
                <div style="text-align:center;color:#6b7280">
                    <div style="font-size:18px;margin-bottom:8px">Game Area</div>
                    <div>æ¸¸æˆé€»è¾‘æœªå®ç° â€” è¿™é‡Œåªæ˜¯ç•Œé¢å ä½</div>
                </div>
            </div>
        </div>
        <div style="padding:12px;border-top:1px solid rgba(0,0,0,0.06);font-size:12px;color:#374151">æ“ä½œè¯´æ˜ï¼š- ç‚¹å‡»æˆ–æŒ‰é”®æ“ä½œï¼ˆæœªå®ç°ï¼‰</div>
    </div>
</div>`;
                                        app.innerHTML = fallback;
                                        // leave fallback UI default stacking (canvas z-index now controls visibility)
                                        console.log('bootloader: injected fallback UI into #app');
                                }
                        } catch(e) { console.error('bootloader: fallback inject failed', e); }
                }
        }, 200);
    })();
    </script>
</body>

</html>